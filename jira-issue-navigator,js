/**
 * jira-issue-navigator.js
 *
 * Enhance the Jira Issue Navigator by grouping projects
 *
 * (C) 2012 Mark Wiseman
 *
 */
 
 var jiraIssueNavigator = {
	
	IsGrouped: false,

	HideText: '< Hide',
	ShowText: 'Show >',
	
	SetProjectVisibility : function (projectCode, isVisible)
	{
		if( typeof(Storage) !== "undefined" )
		{
			var allJsonProjectVisibility = new Array();
			
			if(window.localStorage.getItem('ProjectVisibility') != null)
				allJsonProjectVisibility = JSON.parse(window.localStorage.getItem('ProjectVisibility'));
			
			var isNew = true;
			
			for(var i = 0; i < allJsonProjectVisibility.length; i++)
			{
				if(allJsonProjectVisibility[i].projectCode == projectCode)
				{
					allJsonProjectVisibility[i].isVisible = isVisible;
					isNew = false;
				}
			}
			
			if(isNew)
			{
				var jsonProjectVisibility = { 
					projectCode : projectCode, 
					isVisible : isVisible 
				};
				
				allJsonProjectVisibility.push(jsonProjectVisibility);
			}
			
			window.localStorage.setItem('ProjectVisibility', JSON.stringify(allJsonProjectVisibility));
		}
	},

	GetSetProjectVisibility : function (projectCode)
	{
		if(typeof(Storage)!=="undefined")
		{
			var allJsonProjectVisibility = new Array();
			
			if(window.localStorage.getItem('ProjectVisibility') != null)
				allJsonProjectVisibility = JSON.parse(window.localStorage.getItem('ProjectVisibility'));
			
			if(allJsonProjectVisibility != "")
			{
			
				for(var i = 0; i < allJsonProjectVisibility.length; i++)
				{
					if(allJsonProjectVisibility[i].projectCode == projectCode)
					{
						return allJsonProjectVisibility[i].isVisible;
					}
				}
			}
			return false;
		}
	},

	SetIsGrouped : function (isGrouped)
	{
		jiraIssueNavigator.IsGrouped = isGrouped;
		
		if( typeof(Storage) !== "undefined" )
		{
			window.localStorage.setItem('IsGrouped', isGrouped);
		}
	},

	GetIsGrouped : function ()
	{
		if( typeof(Storage) !== "undefined" )
		{
			if(window.localStorage.getItem('IsGrouped') != null)
				jiraIssueNavigator.IsGrouped = window.localStorage.getItem('IsGrouped');
		}
		
		return jiraIssueNavigator.IsGrouped;
	},

	GroupIssues : function ()
	{
		if(jiraIssueNavigator.GetIsGrouped())
			jiraIssueNavigator.UnGroupIssues();
			
		jiraIssueNavigator.SetIsGrouped(true);
		
		var lastProject = '';
		var columns = $("#issuetable tr:first td").length;

		$(".issuetable-wrap tr td.issuekey a").each(function()
		{
			var currentProject = $(this).text().substring(0, $(this).text().indexOf('-'));
			
			if(currentProject != lastProject)
			{
				var headerRow = "<tr class='my_groups' projectCode='" + currentProject + "'>";
				headerRow += "<td colspan='" + (columns - 1) + "'><h3>" + currentProject + "</h3><h4></h4></td>";		
				headerRow += "<td align='right'><a class='smallgrey showhide' href=''>" + jiraIssueNavigator.HideText + "</a></td>";		
				headerRow += "</tr>";
				
				$(this).parents('tr:first').before(headerRow);
				lastProject = currentProject;
			}
		});

		$("tr.my_groups").each(function(){
			var issues = 0;
			var isGroup = false;
			
			var tr = $(this);

			//Update the Group Titles with Totals
			
			while(!isGroup)
			{
				var tr = tr.next();
				
				if(tr.length == 0){
					isGroup = true; //there are no more issues
				}
				
				if(tr.hasClass('my_groups')) {
					isGroup = true;
				}
				else {
					issues += 1;
				}
			}
			
			$(this).find('h4').append(issues);
			
			//Show or hide this group
			
			var isVisible = jiraIssueNavigator.GetSetProjectVisibility($(this).attr('projectCode'));
			
			if(isVisible == false)
			{
				$(this).find("a.showhide").click();
			}
		});

		$("tr.my_groups h3")
			.width(80)
			.css({ float: "left" });

		$("tr.my_groups h4")
			.width(20)
			.css({ float: "left", "text-align": "right" });
		
		$("tr a.showhide")
			.css({ "white-space": "nowrap" });
			
		$("tr.my_groups").mouseenter(function(){
			$(this).css({ "background-color": "#C0C0C0" });
		});
		
		$("tr.my_groups").mouseleave(function(){
			$(this).css({ "background-color": "#D2D2D2" });
		});
	},

	UnGroupIssues : function ()
	{
		$("tr.my_groups").remove();
		$("tr").show();
		
		jiraIssueNavigator.SetIsGrouped(false)
	},

	ResetSettings : function ()
	{
		if( typeof(Storage) !== "undefined" )
		{
			var allJsonProjectVisibility = new Array();
			window.localStorage.setItem('ProjectVisibility', allJsonProjectVisibility);
		}
	},

	ShowHideGroup : function (link)
	{
		var isVisible = false;

		$(link).closest("tr").nextAll().each(function() {
			if ($(this).hasClass('my_groups')) 
				return false;
			
			$(this).toggle();
			
			isVisible = $(link).is(":visible");
		});
		
		var projectCode = $(link).parents('tr:first').attr('projectCode');
		
		jiraIssueNavigator.SetProjectVisibility(projectCode, isVisible);
		
		if($(link).text() == jiraIssueNavigator.ShowText)
			$(link).text(jiraIssueNavigator.HideText);
		else
			$(link).text(jiraIssueNavigator.ShowText);
	},
 };
 

$(document).ready(function() {
	
	if(jiraIssueNavigator.GetIsGrouped() == "true")
		jiraIssueNavigator.GroupIssues();
	
	$("#jinGroupItems").click(function()
	{
		jiraIssueNavigator.GroupIssues();
		return false;
	});
	
	$("#jinUnGroupItems").click(function()
	{
		jiraIssueNavigator.UnGroupIssues();
		return false;
	});
	
	$("#jinResetGroup").click(function()
	{
		jiraIssueNavigator.ResetSettings();
		jiraIssueNavigator.UnGroupIssues();
		return false;
	});
});


$(".issuetable-wrap tr.my_groups a").live("click", function(event)
{
	jiraIssueNavigator.ShowHideGroup(this);
	return false;
});